(in-package :cl-user)
(defpackage cl-radar.test-wavegen
  (:use :cl :clunit))
(in-package :cl-radar.test-wavegen)

(cl-syntax:use-syntax :annot)

(defsuite WavegenSuite (CL-RADAR.TEST-MAIN::MAINSUITE))

(deftest test-sines-fill-2ch-array (WavegenSuite)
  (setf cl-radar.wavegen::*phase* 0.0)
  (assert-true
      (cl-radar.math:float-multidim-array-mostly-equal-p
       (cl-radar.wavegen:sines-fill-2ch-array (make-array '(2 10) :initial-element 0.0))
       #2A((0.0 0.0065447977 0.013088474 0.019629909 0.026167978 0.032701563
                0.03922955 0.045750808 0.052264232 0.058768697)
           (0.0 6.544798e-4 0.0013088475 0.001962991 0.0026167978 0.0032701564
                0.003922955 0.0045750807 0.0052264235 0.00587687)))))


(deftest test-signals-fill-2ch-array (WavegenSuite)
  (setf cl-radar.wavegen::*phase* 0.0)
  (assert-true
      (cl-radar.math:float-multidim-array-mostly-equal-p
       (cl-radar.wavegen:signals-fill-2ch-array
        (make-array '(2 10) :initial-element 0.0)
        :left-sig-next-fn (lambda () (cl-radar.wavegen:ramp-get-next 48000 4800)))
       #2A((-0.25 -0.17337579 -0.09675158 -0.020127371 0.05649684 0.13312104
                  0.20974526 0.28636947 0.3629937 0.4396179)
           (0.0065447977 0.019629909 0.032701563 0.045750808 0.058768697 0.07174631
                         0.08467475 0.09754516 0.11034872 0.12307665))))

  (setf cl-radar.wavegen::*phase* 0.0)
  (assert-true
      (cl-radar.math:float-multidim-array-mostly-equal-p
       (cl-radar.wavegen:signals-fill-2ch-array
        (make-array '(2 10) :initial-element 0.0)
        :left-sig-next-fn (lambda () (cl-radar.wavegen:ramp-get-next 48000 4800))
        :right-sig-next-fn (lambda () (cl-radar.wavegen:sines-get-next 48000 4800))
        :left-ampl 0.7
        :right-ampl 2.1)
       #2A((-0.175 -0.12136305 -0.067726105 -0.014089159 0.039547786 0.09318473
                0.14682168 0.20045863 0.25409558 0.30773252)
        (0.6171745 0.9986093 5.9488156e-16 -0.9986093 -0.6171745 0.6171745
                   0.9986093 -3.3445854e-15 -0.9986093 -0.6171745))))

  (setf cl-radar.wavegen::*phase* 0.0)
  (assert-true
      (cl-radar.math:float-multidim-array-mostly-equal-p
       (cl-radar.wavegen:signals-fill-2ch-array (make-array '(2 24) :initial-element 0.0) :left-sig-next-fn (lambda () (cl-radar.wavegen:ramp-get-next 48000 4800)) :right-sig-next-fn (lambda () (cl-radar.wavegen:sines-get-next 48000 4800)) :left-ampl 0.7 :right-ampl 2.1)
       #2A((-0.175 -0.12136305 -0.067726105 -0.014089159 0.039547786 0.09318473
                   0.14682168 0.20045863 0.25409558 0.30773252 0.36136946 -0.14818153
                   -0.094544575 -0.040907633 0.012729314 0.06636626 0.12000321 0.17364015
                   0.2272771 0.28091404 0.33455098 0.38818794 -0.14818153 -0.094544575)
           (0.6171745 0.9986093 5.9488156e-16 -0.9986093 -0.6171745 0.6171745
                      0.9986093 -3.3445854e-15 -0.9986093 -0.6171745 0.0 0.9986093 0.6171745
                      -0.6171745 -0.9986093 6.7541147e-16 0.9986093 0.6171745 -0.6171745
                      -0.9986093 5.0811724e-15 0.0 0.9986093 0.6171745))))



  (setf cl-radar.wavegen::*phase* 0.0)
  (assert-true
      (cl-radar.math:float-multidim-array-mostly-equal-p
       (cl-radar.wavegen:signals-fill-2ch-array (make-array '(2 24) :initial-element 0.0) :left-sig-next-fn (lambda () (cl-radar.wavegen:ramp-get-next 48000 4800)) :right-sig-next-fn (lambda () (cl-radar.wavegen:sines-get-next 48000 4800)))
       #2A((-0.25 -0.17337579 -0.09675158 -0.020127371 0.05649684 0.13312104
                  0.20974526 0.28636947 0.3629937 0.4396179 0.5162421 -0.2116879 -0.13506368
                  -0.058439475 0.018184735 0.09480894 0.17143315 0.24805737 0.32468158
                  0.4013058 0.47792998 0.5545542 -0.2116879 -0.13506368)
           (0.29389262 0.47552827 2.8327693e-16 -0.47552827 -0.29389262 0.29389262
                       0.47552827 -1.5926599e-15 -0.47552827 -0.29389262 0.0 0.47552827
                       0.29389262 -0.29389262 -0.47552827 3.2162452e-16 0.47552827 0.29389262
                       -0.29389262 -0.47552827 2.419606e-15 0.0 0.47552827 0.29389262))))

  (setf cl-radar.wavegen::*phase* 0.0)
  (assert-true
      (cl-radar.math:float-multidim-array-mostly-equal-p
       (cl-radar.wavegen:signals-fill-2ch-array
        (make-array '(2 24) :initial-element 0.0)
        :left-sig-next-fn #'cl-radar.wavegen:sines-get-next
        :right-sig-next-fn #'cl-radar.wavegen:ramp-get-next)
       #2A((0.0 0.013088474 0.026167978 0.03922955 0.052264232 0.06526309 0.07821723
                0.09111776 0.10395584 0.11672268 0.12940952 0.14200768 0.1545085
                0.16690344 0.17918397 0.19134171 0.20336832 0.21525554 0.22699524
                0.23857938 0.25 0.26124927 0.27231953 0.28320313)
           (-0.24920183 -0.24760549 -0.24600916 -0.24441282 -0.24281648 -0.24122015
                        -0.2396238 -0.23802747 -0.23643112 -0.23483479 -0.23323846 -0.23164211
                        -0.23004578 -0.22844943 -0.2268531 -0.22525677 -0.22366042 -0.2220641
                        -0.22046775 -0.21887141 -0.21727507 -0.21567874 -0.2140824 -0.21248606))))

  (setf cl-radar.wavegen::*phase* 0.0)
  (assert-true
      (cl-radar.math:float-multidim-array-mostly-equal-p
       (cl-radar.wavegen:signals-fill-2ch-array
        (make-array '(2 24) :initial-element 0.0)
        :left-sig-next-fn #'cl-radar.wavegen:sines-get-next
        :right-sig-next-fn #'cl-radar.wavegen:ramp-get-next)
       #2A((0.0 0.013088474 0.026167978 0.03922955 0.052264232 0.06526309 0.07821723
                0.09111776 0.10395584 0.11672268 0.12940952 0.14200768 0.1545085
                0.16690344 0.17918397 0.19134171 0.20336832 0.21525554 0.22699524
                0.23857938 0.25 0.26124927 0.27231953 0.28320313)
           (-0.24920183 -0.24760549 -0.24600916 -0.24441282 -0.24281648 -0.24122015
                        -0.2396238 -0.23802747 -0.23643112 -0.23483479 -0.23323846 -0.23164211
                        -0.23004578 -0.22844943 -0.2268531 -0.22525677 -0.22366042 -0.2220641
                        -0.22046775 -0.21887141 -0.21727507 -0.21567874 -0.2140824 -0.21248606)))))

(deftest test-relative-primes (WavegenSuite)
  (assert-equal
      (cl-radar.wavegen:all-relative-primes 32)
      '(1 3 5 7 9 11 13 15 17 19 21 23 25 27 29 31))

  (assert-equal
      (cl-radar.wavegen:all-relative-primes 42)
      '(1 5 11 13 17 19 23 25 29 31 37 41))

  (assert-equal
      (cl-radar.wavegen:first-relative-prime 14)
      3))

(deftest test-zadoff-chu (WavegenSuite)
  (assert-true
      (cl-radar.math::complex-array-mostly-equal-p
       (cl-radar.wavegen::zadoff-chu-sequence 16 :root 3)
       #(#C(1.0d0 -0.0d0)
         #C(0.38268343236508984d0 -0.9238795325112867d0)
         #C(-0.9238795325112868d0 0.38268343236508967d0)
         #C(0.7071067811865477d0 -0.7071067811865472d0)
         #C(0.7071067811865466d0 0.7071067811865485d0)
         #C(0.3826834323650863d0 0.9238795325112882d0)
         #C(0.9238795325112868d0 0.38268343236508945d0)
         #C(-4.904777002955296d-16 -1.0d0)
         #C(-3.4296300182491773d-15 1.0d0)
         #C(-0.9238795325112851d0 -0.3826834323650938d0)
         #C(-0.3826834323650813d0 -0.9238795325112903d0)
         #C(-0.7071067811865497d0 -0.7071067811865454d0)
         #C(-0.7071067811865495d0 0.7071067811865456d0)
         #C(0.9238795325112916d0 -0.3826834323650781d0)
         #C(-0.38268343236508806d0 0.9238795325112874d0)
         #C(-1.0d0 -1.9581969173625882d-15))))

  (assert-true
      (cl-radar.math::complex-array-mostly-equal-p
       (cl-radar.wavegen::zadoff-chu-sequence 16 :root 3 :offset 1.0)
       #(#C(0.38268343236508984d0 -0.9238795325112867d0)
         #C(-0.9238795325112868d0 0.38268343236508967d0)
         #C(0.7071067811865477d0 -0.7071067811865472d0)
         #C(0.7071067811865466d0 0.7071067811865485d0)
         #C(0.3826834323650863d0 0.9238795325112882d0)
         #C(0.9238795325112868d0 0.38268343236508945d0)
         #C(-4.904777002955296d-16 -1.0d0)
         #C(-3.4296300182491773d-15 1.0d0)
         #C(-0.9238795325112851d0 -0.3826834323650938d0)
         #C(-0.3826834323650813d0 -0.9238795325112903d0)
         #C(-0.7071067811865497d0 -0.7071067811865454d0)
         #C(-0.7071067811865495d0 0.7071067811865456d0)
         #C(0.9238795325112916d0 -0.3826834323650781d0)
         #C(-0.38268343236508806d0 0.9238795325112874d0)
         #C(-1.0d0 -1.9581969173625882d-15)
         #C(-1.0d0 -9.798412354452001d-15))))

  (assert-true
      (cl-radar.math::complex-array-mostly-equal-p
       (cl-radar.wavegen::zadoff-chu-sequence 16 :root 3 :offset 1.5)
       #(#C(-0.5956993044924332d0 -0.8032075314806449d0)
         #C(0.42755509343028136d0 0.9039892931234437d0)
         #C(-0.989176509964781d0 -0.1467304744553616d0)
         #C(-0.4275550934302802d0 -0.9039892931234442d0)
         #C(-0.5956993044924338d0 -0.8032075314806445d0)
         #C(-0.9039892931234437d0 0.4275550934302813d0)
         #C(0.9891765099647806d0 0.14673047445536447d0)
         #C(-0.903989293123444d0 0.4275550934302807d0)
         #C(-0.5956993044924298d0 -0.8032075314806475d0)
         #C(-0.42755509343028464d0 -0.9039892931234421d0)
         #C(-0.9891765099647798d0 -0.1467304744553698d0)
         #C(0.42755509343027404d0 0.9039892931234471d0)
         #C(-0.5956993044924224d0 -0.803207531480653d0)
         #C(0.903989293123447d0 -0.4275550934302745d0)
         #C(0.9891765099647778d0 0.1467304744553829d0)
         #C(0.9039892931234415d0 -0.42755509343028597d0)))))
